# Implementation Plan: Interest Accrual

**Branch**: `005-interest-accrual` | **Date**: 2026-02-07 | **Spec**: `specs/005-interest-accrual/spec.md`
**Input**: Feature specification from `/specs/005-interest-accrual/spec.md`

## Summary

Add per-child interest accrual to savings accounts. Parents configure an annual interest rate (stored as basis points on the `children` table), and a background scheduler automatically calculates and credits monthly interest as `interest`-type transactions. Interest appears in the existing transaction history for both parents and children. The implementation follows established patterns: store layer for data access, HTTP handler for the rate-setting endpoint, and a scheduler goroutine matching the allowance scheduler pattern.

## Technical Context

**Language/Version**: Go 1.24.0 (backend), TypeScript 5.3.3 + React 18.2.0 (frontend)
**Primary Dependencies**: `modernc.org/sqlite`, `testify`, react-router-dom, Vite
**Storage**: SQLite with WAL mode (separate read/write connections)
**Testing**: `go test ./...` (backend), ESLint + tsc --noEmit (frontend)
**Target Platform**: Linux/macOS server, web browser
**Project Type**: Web application (backend + frontend)
**Performance Goals**: Interest accrual completes for all accounts within 1 minute (SC-005)
**Constraints**: Integer arithmetic only for financial calculations (no floating point)
**Scale/Scope**: 100+ child accounts

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Test-First Development — PASS

- Store tests (`interest_test.go`) will cover: setting rates, applying interest, duplicate prevention, edge cases (zero balance, zero rate, sub-cent rounding)
- Scheduler tests (`scheduler_test.go`) will cover: processing due accounts, skipping already-accrued accounts
- Handler tests (`handler_test.go`) will cover: rate validation, authorization, success responses
- Interest calculation uses integer arithmetic — exact cent amounts are testable without floating-point tolerance
- No untested code paths affecting financial data

### II. Security-First Design — PASS

- `PUT /api/children/{id}/interest-rate` requires parent authentication and family ownership verification
- Interest rate validated to 0–10000 bps (0%–100%) — prevents nonsensical rates
- Interest transactions use the family's parent_id — maintains referential integrity
- All financial mutations (balance update + transaction insert + last_interest_at update) are atomic within a single DB transaction

### III. Simplicity — PASS

- No new tables — two columns added to `children`, one new transaction type value
- Follows existing scheduler pattern (allowance scheduler) — no new infrastructure
- Single endpoint for rate management — no over-engineering
- Interest rate stored as integer basis points — avoids floating-point complexity
- No rate history tracking (YAGNI)
- No compound interest (simple interest is appropriate for an educational tool)

### Post-Design Re-Check — PASS

- Data model adds minimal schema changes (2 columns + 1 CHECK constraint update)
- API contract has 1 new endpoint + 1 enhanced existing endpoint
- All design decisions documented in research.md align with constitution principles

## Project Structure

### Documentation (this feature)

```text
specs/005-interest-accrual/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Research decisions (R-001 through R-008)
├── data-model.md        # Schema changes (children columns + transaction type)
├── quickstart.md        # Quick reference and verification steps
├── contracts/
│   └── api.md           # API contracts (PUT interest-rate, enhanced balance)
├── checklists/
│   └── requirements.md  # Specification quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── internal/
│   ├── store/
│   │   ├── sqlite.go           # Modify: migrations (columns + CHECK constraint)
│   │   ├── interest.go         # Create: interest store (set rate, apply interest)
│   │   └── interest_test.go    # Create: store tests
│   ├── interest/
│   │   ├── scheduler.go        # Create: background interest scheduler
│   │   ├── scheduler_test.go   # Create: scheduler tests
│   │   ├── handler.go          # Create: HTTP handler for interest rate endpoint
│   │   └── handler_test.go     # Create: handler tests
│   └── balance/
│       └── handler.go          # Modify: include interest rate in balance response
├── main.go                     # Modify: wire up interest scheduler and routes

frontend/
├── src/
│   ├── types.ts                        # Modify: add 'interest' transaction type
│   ├── components/
│   │   ├── TransactionHistory.tsx       # Modify: display interest transactions
│   │   ├── ChildCard.tsx (or similar)   # Modify: show interest rate on parent dashboard
│   │   └── InterestRateForm.tsx         # Create: interest rate configuration UI
```

**Structure Decision**: Web application structure matching existing codebase layout. New Go package `internal/interest/` for scheduler and handler (following `internal/allowance/` pattern). Store methods in `internal/store/` (following existing store pattern). Frontend changes are minimal modifications to existing components plus one new form component.

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Rate storage | `interest_rate_bps` INTEGER on `children` | Per-child, integer basis points avoids float issues (R-001) |
| Duplicate prevention | `last_interest_at` DATETIME on `children` | Atomic update in same transaction as interest credit (R-002) |
| Transaction type | Add `interest` to CHECK constraint | Reuses existing transaction infrastructure (R-003) |
| Scheduler | `interest.Scheduler` goroutine | Matches allowance.Scheduler pattern — proven in codebase (R-004) |
| Calculation | `balance_cents * rate_bps / 12 / 10000` | Integer arithmetic, standard half-up rounding (R-005) |
| API | `PUT /api/children/{id}/interest-rate` | Single field, follows existing endpoint patterns (R-006) |
| Parent ID | Family's parent_id on interest transactions | Maintains NOT NULL constraint, no schema changes needed (R-008) |

## Complexity Tracking

> No constitution violations. All design choices follow established patterns with minimal new abstractions.
